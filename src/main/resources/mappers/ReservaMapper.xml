<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="edu.eci.cvds.sampleprj.dao.mybatis.mappers.ReservaMapper">
	<resultMap type='Reserva' id='ReservaResult'>
		<id property='id' column='id'/>
		<result property='tipo' column='tipo'/>
		<result property='estado' column='estado'/>
		<result property='fechaSolicitud' column='fecha_solicitud'/>
		<association property="usuario" javaType="Usuario" resultMap="edu.eci.cvds.sampleprj.dao.mybatis.mappers.UsuarioMapper.UsuarioResult" columnPrefix='usuario_'></association>
		<association property="recurso" javaType="Recurso"  resultMap="edu.eci.cvds.sampleprj.dao.mybatis.mappers.RecursoMapper.RecursoResult" columnPrefix='recurso_'></association>
		<collection property='eventosAsignados' ofType='Evento' resultMap='edu.eci.cvds.sampleprj.dao.mybatis.mappers.EventoMapper.EventoResult' columnPrefix='evento_'></collection>
	</resultMap>
	

	<select parameterType='map' id='consultarReservasPendientes' resultMap='ReservaResult'>
    SELECT 
      res.id as id, 
      res.tipo as tipo,
      res.estado as estado,
	  res.fecha_solicitud as fecha_solicitud,

	  us.correo as usuario_correo,
		us.u_area as usuario_area,
	  us.nombre as usuario_nombre,

      recu.id as recurso_id, 
			recu.nombre as recurso_nombre, 
			recu.tipo as recurso_tipo, 
			recu.capacidad as recurso_capacidad, 
			recu.estado as recurso_estado, 
			eve.id as evento_id,
			eve.estado as evento_estado, 
			eve.hora_inicio as evento_hora_inicio,
			eve.hora_fin as evento_hora_fin
     FROM
      reserva as res,
			recurso as recu,
			usuario as us,
			evento as eve
     WHERE
      res.recurso=#{id} AND res.recurso=recu.id AND
		    us.correo=res.usuario AND
			eve.reserva=res.id AND res.estado='Activa' AND 
			EXISTS(select * from evento as eve1 where now() &lt;= eve1.hora_inicio and res.id=eve1.reserva);
  </select>

     
  
	<update parameterType="map" id="cancelarReservasPendientes">
	  update reserva as res
	  	set estado='Cancelada'
	  WHERE
			res.recurso=#{id} AND res.estado='Activa' AND
			EXISTS(select * from evento as eve1 where now() &lt;= eve1.hora_inicio and res.id=eve1.reserva);
  </update>

	<insert parameterType="Reserva" id="registrarReserva" useGeneratedKeys="true" keyProperty="reserva.id" keyColumn="id">
    INSERT INTO reserva(tipo,fecha_solicitud ,estado, usuario ,recurso) values (#{reserva.tipo},#{reserva.fechaSolicitud}, #{reserva.estado}, #{reserva.usuario.correo}, #{reserva.recurso.id});
  </insert>

	<select parameterType="map" id="consultarReserva" resultMap='ReservaResult'>
		SELECT
		reserva.id as id,
		reserva.tipo as tipo,
		reserva.estado as estado,
		fecha_solicitud,
		usuario,
		recurso as recurso_id,
		rec.nombre as recurso_nombre,
		rec.ubicacion as recurso_ubicacion,
		rec.tipo as recurso_tipo,
		rec.capacidad as recurso_capacidad,
		rec.estado as recurso_estado
		FROM
		reserva, recurso as rec
		WHERE
			rec.id = reserva.recurso
			<if test="id != null">
				 AND reserva.id = #{id}
			</if>
	</select>


</mapper>