<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="edu.eci.cvds.sampleprj.dao.mybatis.mappers.ReservaMapper">
	<resultMap type='Reserva' id='ReservaResult'>
		<id property='id' column='id'/>
		<result property='tipo' column='tipo'/>
		<result property='estado' column='estado'/>
		<association property="recurso" javaType="Recurso"  resultMap="edu.eci.cvds.sampleprj.dao.mybatis.mappers.RecursoMapper.RecursoResult" columnPrefix='recurso_'></association>      
		<collection property='eventosAsignados' ofType='Evento' resultMap='edu.eci.cvds.sampleprj.dao.mybatis.mappers.HorarioMapper.EventoResult' columnPrefix='evento_'></collection>
	</resultMap>
	

	<select parameterType='map' id='consultarReservasPendientes' resultMap='ReservaResult'>
    SELECT 
      res.id as id, 
      res.tipo as tipo,
      res.estado as estado,
      recu.id as recurso_id, 
			recu.nombre as recurso_nombre, 
			recu.tipo as recurso_tipo, 
			recu.capacidad as recurso_capacidad, 
			recu.estado as recurso_estado, 
			eve.id as evento_id,
			eve.estado as evento_estado, 
			eve.hora_inicio as evento_horarioi_horaInicio,
			eve.hora_fin as evento_horariof_horaFin
     FROM
      reserva as res,
			recurso as recu, 
			evento as eve
     WHERE
      res.recurso=#{id} AND res.recurso=recu.id AND
			eve.reserva=res.id AND res.estado='Activa' AND 
			EXISTS(select * from evento as eve1 where now() &lt;= eve1.hora_inicio and res.id=eve1.reserva);
  </select>

     
  
	<update parameterType="map" id="cancelarReservasPendientes">
	  update reserva as res
	  	set estado='Cancelada'
	  WHERE
			res.recurso=#{id} AND res.estado='Activa' AND
			EXISTS(select * from evento as eve1 where now() &lt;= eve1.hora_inicio and res.id=eve1.reserva);
  </update>

	<insert parameterType="map" id="registrarReserva">
    INSERT INTO reserva(tipo, estado, usuario ,recurso) values (#{reserva.tipo}, #{reserva.estado}, #{usuario}, #{reserva.recurso.id});
  </insert>


  

	
</mapper>