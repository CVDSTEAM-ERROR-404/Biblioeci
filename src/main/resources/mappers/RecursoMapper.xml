<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="edu.eci.cvds.sampleprj.dao.mybatis.mappers.RecursoMapper">
	<resultMap type='Recurso' id='RecursoResult'>
		<id property='id' column='id'/>
		<result property='nombre' column='nombre'/>
		<result property='ubicacion' column='ubicacion'/>  
		<result property='tipo' column='tipo'/>
		<result property='capacidad' column='capacidad'/>  
		<result property='estado' column='estado'/>
	</resultMap>
  
  
  <select parameterType='map' id='consultarRecurso' resultMap='RecursoResult'>
    SELECT 
      id, 
      nombre,
      ubicacion,
      tipo,
      capacidad,
      estado
     FROM
      recurso
     WHERE
      id=#{id};
  </select>

  <select parameterType='map' id='consultarRecursos' resultMap='RecursoResult'>
    SELECT 
      id, 
      nombre,
      ubicacion,
      tipo,
      capacidad,
      estado
    FROM
      recurso;
  </select>


  <select parameterType='map' id='consultarRecursosDisponibles' resultMap='RecursoResult'>
    SELECT 
      id, 
      nombre,
      ubicacion,
      tipo,
      capacidad,
      estado
    FROM
      recurso
	WHERE estado='Disponible' 
	<if test="tipo != null">
		AND tipo = #{tipo}
	</if>
	<if test="capacidad > 0">
		AND capacidad=#{capacidad}
	</if>
	<if test="ubicacion != null">
		AND ubicacion=#{ubicacion}
	</if>	
  </select>

  <update id="cambiarEstado" parameterType="map">
    UPDATE recurso SET estado = #{estado}
    WHERE id = #{id};
  </update>
   
  <insert parameterType="Recurso" id="agregarRecurso" useGeneratedKeys="true" keyProperty="rec.id" keyColumn="id">
    INSERT INTO recurso(nombre, ubicacion, tipo, capacidad, estado) values (#{rec.nombre}, #{rec.ubicacion}, #{rec.tipo}, #{rec.capacidad}, #{rec.estado});
  </insert>


  <select parameterType='map' id='consultarEventosRecurso' resultMap='edu.eci.cvds.sampleprj.dao.mybatis.mappers.EventoMapper.EventoResult'>
        SELECT
            id,
            estado,
            hora_inicio,
            hora_fin
        from recurso as rec, reserva as res, evento as eve
        WHERE rec.id=#{recurso} and rec.id=res.recurso and rec.id=eve.reserva AND
            ((#{fecha_inicio} &lt; eve.hora_fin and eve.hora_inicio &lt; #{fecha_final}) or
            (#{fecha_inicio} &lt;= eve.hora_inicio and eve.hora_fin &lt;= #{fecha_final}) or
            ( eve.hora_inicio &lt;= #{fecha_inicio} and  #{fecha_final} &lt;= eve.hora_fin) )
    </select>
  
</mapper>